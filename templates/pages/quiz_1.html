<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stage 1 - Quiz</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/quiz.css') }}"
    />
    <style>
      /* ===============================
   ğŸŒŸ RESPONSIVE MOBILE FIX
================================ */

      @media (max-width: 768px) {
        body {
          text-align: center;
          overflow-x: hidden;
        }
        /* Tombol Back */
        .back {
          position: absolute !important;
          width: 48px;
          height: 48px;
          top: 12px;
          left: 12px;
          margin: 0 !important;
          z-index: 12000;
        }
        .gambar_back {
          width: 28px;
          height: 28px;
          top: 10px;
          left: 10px;
        }
        /* Judul atas */
        .kotak_materi_diatas {
          width: 50%;
          height: 60px;
          margin-top: 20px;
          border-radius: 40px;
          font-size: 18px;
        }
        .tulisan_materi_diatas {
          font-size: 22px;
        }
        /* Cerita container */
        .container-cerita {
          width: 90%;
          height: auto;
          min-height: 400px;
          top: 130px;
          padding: 25px 20px;
        }
        .cerita {
          font-size: 20px !important;
          line-height: 1.6;
          text-align: justify;
        }
        #soal_lanjut {
          position: relative;
          margin-top: 25px;
          font-size: 20px !important;
          width: 80%;
        }
        /* Quiz container */
        .quiz-container {
          width: 90%;
          padding: 25px;
          top: 150px;
        }
        .question {
          font-size: 20px;
        }
        .options button {
          width: 100%;
          font-size: 18px;
          padding: 12px;
        }
        .next-btn {
          width: 60%;
          font-size: 18px;
          padding: 10px;
        }
        .result {
          font-size: 18px;
        }
        .result-box {
          font-size: 18px;
          padding: 15px;
        }
        .materi-btn {
          font-size: 18px;
          padding: 10px 20px;
        }
        .cerita::first-letter {
          font-size: 37.5px;
          font-weight: 700;
          color: #f5a623;
          float: left;
          margin-right: 6px;
          margin-top: -20px;
          margin-bottom: -10px;
        }
      }
    </style>
  </head>

  <body>
    <a href="{{ url_for('quiz') }}">
      <div class="back">
        <img
          src="/static/Image/back.png"
          alt="gambar kembali"
          class="gambar_back"
        />
      </div>
    </a>

    <div class="kotak_materi_diatas">
      <div class="tulisan_materi_diatas">Stage 1 - Quiz</div>
    </div>

    <div class="quiz-container" style="display: none">
      <div id="quiz">
        <div class="question" id="question"></div>
        <div class="options" id="options"></div>
        <button class="next-btn" id="nextBtn">Next</button>
      </div>
      <div class="result" id="result"></div>
    </div>

    <div class="container-cerita">
      <div class="cerita-scroll">
        <p class="cerita">
          Kamu baru tiba di Kalimantan Selatan. Di depanmu, berdiri rumah tinggi
          dari kayu ulin yang megah ğŸ¡. Seorang nenek dengan senyum hangat
          menyapa, â€œSelamat datang di kampung kami, Nak!â€ ğŸ˜Š<br /><br />
          Ia menunjuk sebuah rumah besar di depannya. â€œIni Rumah Bubungan Tinggi
          â€” dulu Sultan Banjar tinggal di sini.â€ Kamu terperangah. â€œWah tinggi
          banget, Nek! Kalau jatuh dari tangga, bisa langsung teleport ke masa
          depan nih!â€<br /><br />
          Nenek tertawa, â€œBisa aja kamu, Nak. Tapi itu baru satu rumah. Masih
          ada satu rumah adat lain yang harus kamu lihat.â€<br /><br />
          Ia mengajakmu berjalan ke arah sebuah rumah indah dengan ukiran halus.
          â€œIni Balai Bini,â€ katanya. â€œDulu jadi tempat untuk para putri sultan
          atau keluarga bangsawan dari pihak perempuan. Lihat ukirannya? Cantik
          kan?â€ ğŸŒ¸<br /><br />
          Kamu mengangguk kagum. â€œWah, rumah adat Banjar keren-keren ya, Nek!
          Kalau aku tinggal di sini, bisa jadi arsitek zaman kerajaan nih!â€
          Nenek tertawa lagi. â€œBoleh saja, Nak. Yang penting kamu belajar dulu
          tentang semuanya.â€ ğŸ˜<br />
        </p>
      </div>
      <button id="soal_lanjut" onclick="soal_lanjut()">Lanjut</button>
    </div>

    <script src="/static/js/script.js"></script>
    <script>
      // ======== DATA PERTANYAAN =========
      const quizData = [
        {
          question: "Siapa yang menyambut tokoh utama di kampung tersebut?",
          options: [
            "Seorang Nenek",
            "Seorang Pemuda",
            "Seorang Pangeran",
            "Seorang Pedagang",
          ],
          answer: "Seorang Nenek",
        },
        {
          question: "Rumah apa yang pertama kali dilihat oleh tokoh utama?",
          options: ["Balai Bini", "Balai Laki", "Palimasan", "Bubungan Tinggi"],
          answer: "Bubungan Tinggi",
        },
        {
          question: "Balai Bini dulunya digunakan untuk apa?",
          options: [
            "Tempat menyimpan harta",
            "Tempat tinggal putri sultan",
            "Tempat tinggal laki-laki",
            "Tempat upacara adat",
          ],
          answer: "Tempat tinggal putri sultan",
        },
        {
          question: "Apa yang membuat Balai Bini terlihat indah secara visual?",
          options: [
            "Ukiran kembang bogam dan kandang rasi",
            "Atapnya terbuat dari daun kelapa",
            "Dindingnya berwarna-warni seperti pelangi",
            "Penuh hiasan kaca patri warna-warni",
          ],
          answer: "Ukiran kembang bogam dan kandang rasi",
        },
        {
          question:
            "Mengapa rumah Bubungan Tinggi memiliki atap sangat tinggi dan tanpa plafon?",
          options: [
            "Agar bisa melihat burung lewat dari dalam rumah",
            "Karena masyarakat Banjar tidak suka plafon",
            "Untuk menampilkan struktur bubungan yang khas",
            "Supaya rumah terlihat lebih murah",
          ],
          answer: "Untuk menampilkan struktur bubungan yang khas",
        },
      ];

      let currentQuestion = 0;
      let score = 0;
      let startTime; // Variabel waktu mulai

      const questionEl = document.getElementById("question");
      const optionsEl = document.getElementById("options");
      const nextBtn = document.getElementById("nextBtn");
      const resultEl = document.getElementById("result");

      function loadQuestion() {
        const current = quizData[currentQuestion];
        questionEl.textContent = current.question;
        optionsEl.innerHTML = "";
        nextBtn.style.display = "none";
        current.options.forEach((opt) => {
          const btn = document.createElement("button");
          btn.textContent = opt;
          btn.onclick = () => checkAnswer(btn, opt);
          optionsEl.appendChild(btn);
        });
      }
      // perhitungan scorenya
      function checkAnswer(btn, selected) {
        const correct = quizData[currentQuestion].answer;
        const buttons = optionsEl.querySelectorAll("button");
        buttons.forEach((b) => (b.disabled = true));
        if (selected === correct) {
          btn.classList.add("correct");
          score++;
        } else {
          btn.classList.add("wrong");
          buttons.forEach((b) => {
            if (b.textContent === correct) b.classList.add("correct");
          });
        }
        nextBtn.style.display = "inline-block";
      }

      nextBtn.addEventListener("click", () => {
        currentQuestion++;
        if (currentQuestion < quizData.length) {
          loadQuestion();
        } else {
          finishQuiz();
        }
      });

      function finishQuiz() {
        document.getElementById("quiz").style.display = "none";

        // 1. Hitung durasi waktu
        const endTime = new Date();
        const durasiDetik = Math.floor((endTime - startTime) / 1000);

        const minCorrect = Math.ceil(quizData.length / 2);

        // 2. Kirim ke database
        fetch("/api/submit_quiz", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            game_name: "quiz",
            stage: 1,
            score: score,
            total_soal: quizData.length,
            time_taken: durasiDetik,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            resultEl.innerHTML = `<strong>Kamu menjawab ${score}/${quizData.length} dengan benar!</strong><br>
                                  <small>Waktu pengerjaan: ${durasiDetik} detik</small><br><br>`;

            if (data.passed) {
              resultEl.innerHTML += `
                    <div class="result-box success">
                        ğŸ‰ Selamat! Kamu berhasil menjawab minimal ${minCorrect} soal dengan benar.<br>
                        Stage berikutnya telah terbuka!
                    </div>`;
              setTimeout(() => {
                window.location.href = "{{ url_for('quiz') }}";
              }, 3000);
            } else {
              resultEl.innerHTML += `
                    <div class="result-box fail">
                        ğŸ˜¢ Kamu hanya menjawab ${score} dari ${quizData.length} dengan benar.<br>
                        <p>Pelajari kembali materinya sebelum mencoba lagi.</p>
                        <a href="{{ url_for('materi') }}" class="materi-btn">ğŸ“– Lihat Materi</a>
                    </div>`;
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function shuffleQuestions(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      function soal_lanjut() {
        document.querySelector(".container-cerita").style.display = "none";
        document.querySelector(".quiz-container").style.display = "block";
        startTime = new Date(); // Catat waktu mulai di sini
      }

      // Jalankan inisialisasi
      shuffleQuestions(quizData);
      loadQuestion();

      // Script tambahan untuk cerita (biar fungsi soal_lanjut jalan)
      function soal_lanjut() {
        document.querySelector(".container-cerita").style.display = "none";
        document.querySelector(".quiz-container").style.display = "block";
        startTime = new Date();
      }
    </script>
  </body>
</html>
