<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stage 4 - Quiz</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/quiz.css') }}"
    />

    <style>
      /* ===============================
        ğŸŒŸ RESPONSIVE MOBILE FIX
      ================================ */
      @media (max-width: 768px) {
        body {
          text-align: center;
          overflow-x: hidden;
        }
        /* Tombol Back */
        .back {
          position: absolute !important;
          width: 48px;
          height: 48px;
          top: 12px;
          left: 12px;
          margin: 0 !important;
          z-index: 12000;
        }
        .gambar_back {
          width: 28px;
          height: 28px;
          top: 10px;
          left: 10px;
        }
        /* Judul atas */
        .kotak_materi_diatas {
          width: 50%;
          height: 60px;
          margin-top: 20px;
          border-radius: 40px;
          font-size: 18px;
        }
        .tulisan_materi_diatas {
          font-size: 22px;
        }
        /* Cerita container */
        .container-cerita {
          width: 90%;
          height: auto;
          min-height: 400px;
          top: 130px;
          padding: 25px 20px;
        }
        .cerita {
          font-size: 20px !important;
          line-height: 1.6;
          text-align: justify;
        }
        /* Huruf pertama besar */
        .cerita::first-letter {
          font-size: 37.5px;
          font-weight: 700;
          color: #f5a623;
          float: left;
          margin-right: 6px;
          margin-top: -20px;
          margin-bottom: -10px;
        }
        #soal_lanjut {
          position: relative;
          margin-top: 25px;
          font-size: 20px !important;
          width: 80%;
        }
        /* Quiz container */
        .quiz-container {
          width: 90%;
          padding: 25px;
          top: 150px;
        }
        .question {
          font-size: 20px;
        }
        .options button {
          width: 100%;
          font-size: 18px;
          padding: 12px;
        }
        .next-btn {
          width: 60%;
          font-size: 18px;
          padding: 10px;
        }
        .result {
          font-size: 18px;
        }
        .result-box {
          font-size: 18px;
          padding: 15px;
        }
        .materi-btn {
          font-size: 18px;
          padding: 10px 20px;
        }
      }
    </style>
  </head>

  <body>
    <a href="{{ url_for('quiz') }}">
      <div class="back">
        <img
          src="/static/Image/back.png"
          alt="gambar kembali"
          class="gambar_back"
        />
      </div>
    </a>

    <div class="kotak_materi_diatas">
      <div class="tulisan_materi_diatas">Stage 4 - Quiz</div>
    </div>

    <div class="quiz-container" style="display: none">
      <div id="quiz">
        <div class="question" id="question"></div>
        <div class="options" id="options"></div>
        <button class="next-btn" id="nextBtn">Next</button>
      </div>

      <div class="result" id="result"></div>
    </div>

    <div class="container-cerita">
      <div class="cerita-scroll">
        <p class="cerita">
          Setelah puas melihat rumah adat, nenek tersenyum dan berkata,
          â€œSekarang kita akan melihat salah satu kekayaan kuliner Banjar, Nak!â€
          ğŸ´<br /><br />
          Ia membawa kamu ke meja kayu di halaman rumah, di atasnya tersusun
          kue-kue tradisional yang harum. â€œIni Wadai Cincin,â€ katanya sambil
          menunjuk kue berbentuk bulat dengan lubang di tengah. â€œDulu setiap
          Wadai Cincin memiliki empat lubang kecil, melambangkan empat penjuru
          mata angin dan keseimbangan alam.â€ ğŸŒ<br /><br />
          Nenek melanjutkan, â€œRasanya manis dan teksturnya kenyal, khas Banjar.
          Kue ini dibuat dari tepung beras, gula merah, sedikit garam, dan air.â€
          ğŸ˜‹<br /><br />
          Ia tersenyum sambil menaruh Putu Mayang di samping Wadai Cincin. â€œNah,
          ini Putu Mayang. Bentuknya menyerupai lunjuran mayang yang berurai,
          kadang juga disebut Puracit. <br /><br />
          Bahan utamanya tepung beras, tepung tapioka, santan, dan gula, yang
          kemudian dibentuk menggunakan cetakan khusus hingga menjadi lembaran
          beruntai seperti mayang.â€ğŸŒ¿ <br /><br />
          Kamu terkagum melihat kue-kue itu. â€œWah, kue tradisional Banjar punya
          makna yang dalam juga ya, Nek!â€ Nenek tertawa hangat, â€œBetul, Nak.
          Semua yang kami wariskan punya filosofi, dari rumah hingga makanan.â€
          âœ¨
        </p>
      </div>
      <button id="soal_lanjut" onclick="soal_lanjut()">Lanjut</button>
    </div>

    <script>
      // ==============================
      // DATA PERTANYAAN QUIZ
      // ==============================
      const quizData = [
        {
          question: "Apa makna empat lubang kecil pada Wadai Cincin?",
          options: [
            "Melambangkan simbol empat musim dalam setahun",
            "Melambangkan agar kue mudah ditaruh di wadah bulat",
            "Melambangkan agar kue lebih cepat matang saat digoreng",
            "Melambangkan empat penjuru mata angin dan keseimbangan alam",
          ],
          answer: "Melambangkan empat penjuru mata angin dan keseimbangan alam",
        },
        {
          question: "Bahan utama pembuatan Wadai Cincin adalahâ€¦",
          options: [
            "Tepung beras, gula merah, sedikit garam, dan air",
            "Tepung tapioka, santan, dan pewarna makanan",
            "Tepung terigu, santan, dan gula pasir",
            "Tepung beras, santan, dan kelapa parut",
          ],
          answer: "Tepung beras, gula merah, sedikit garam, dan air",
        },
        {
          question: "Mengapa kue ini disebut Putu Mayang?",
          options: [
            "Karena dibuat dengan cetakan khusus",
            "Karena bentuknya seperti lunjuran mayang yang berurai",
            "Karena warnanya merah dan hijau",
            "Karena rasanya manis dan kenyal",
          ],
          answer: "Karena bentuknya seperti lunjuran mayang yang berurai",
        },
        {
          question: "Bahan utama Putu Mayang adalahâ€¦",
          options: [
            "Tepung jagung, santan, dan gula pasir",
            "Tepung beras, gula merah, dan kelapa parut",
            "Tepung beras, tepung tapioka, santan, dan gula",
            "Tepung terigu, susu, dan cokelat",
          ],
          answer: "Tepung beras, tepung tapioka, santan, dan gula",
        },
        {
          question: "Apa makna Putu Mayang bagi masyarakat Banjar?",
          options: [
            "Melambangkan seperti warna-warni kekayaan kuliner Banjar",
            "Melambangkan hanya untuk hiasan di acara adat",
            "Melambangkan agar kue terlihat cantik dan menarik anak-anak",
            "Melambangkan ikatan emosional dan kebersamaan antar anggota masyarakat",
          ],
          answer:
            "Melambangkan ikatan emosional dan kebersamaan antar anggota masyarakat",
        },
        {
          question: "Bagaimana Putu Mayang disajikan saat disantap?",
          options: [
            "Langsung dimakan tanpa kuah atau topping apapun",
            "Disajikan bersama kuah santan gula merah",
            "Dibakar di atas bara api agar hangat",
            "Dicampur dengan Wadai Cincin untuk rasa unik",
          ],
          answer: "Disajikan bersama kuah santan gula merah",
        },
      ];

      let currentQuestion = 0;
      let score = 0;
      let startTime; // Variabel waktu mulai

      const questionEl = document.getElementById("question");
      const optionsEl = document.getElementById("options");
      const nextBtn = document.getElementById("nextBtn");
      const resultEl = document.getElementById("result");

      function loadQuestion() {
        const current = quizData[currentQuestion];
        questionEl.textContent = current.question;
        optionsEl.innerHTML = "";
        nextBtn.style.display = "none";
        current.options.forEach((opt) => {
          const btn = document.createElement("button");
          btn.textContent = opt;
          btn.onclick = () => checkAnswer(btn, opt);
          optionsEl.appendChild(btn);
        });
      }

      function checkAnswer(btn, selected) {
        const correct = quizData[currentQuestion].answer;
        const buttons = optionsEl.querySelectorAll("button");
        buttons.forEach((b) => (b.disabled = true));
        if (selected === correct) {
          btn.classList.add("correct");
          score++;
        } else {
          btn.classList.add("wrong");
          buttons.forEach((b) => {
            if (b.textContent === correct) b.classList.add("correct");
          });
        }
        nextBtn.style.display = "inline-block";
      }

      nextBtn.addEventListener("click", () => {
        currentQuestion++;
        if (currentQuestion < quizData.length) {
          loadQuestion();
        } else {
          finishQuiz();
        }
      });

      function finishQuiz() {
        document.getElementById("quiz").style.display = "none";

        // 1. Hitung durasi waktu
        const endTime = new Date();
        const durasiDetik = Math.floor((endTime - startTime) / 1000);

        const minCorrect = Math.ceil(quizData.length / 2);

        // 2. Kirim ke database (Stage 4)
        fetch("/api/submit_quiz", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            game_name: "quiz",
            stage: 4,
            score: score,
            total_soal: quizData.length,
            time_taken: durasiDetik,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            resultEl.innerHTML = `<strong>Kamu menjawab ${score}/${quizData.length} dengan benar!</strong><br>
                                  <small>Waktu pengerjaan: ${durasiDetik} detik</small><br><br>`;

            if (data.passed) {
              resultEl.innerHTML += `
                <div class="result-box success">
                    ğŸ‰ Selamat! Kamu berhasil menjawab minimal ${minCorrect} soal dengan benar.<br>
                    Stage berikutnya telah terbuka!
                </div>`;
              setTimeout(() => {
                window.location.href = "{{ url_for('quiz') }}";
              }, 3500);
            } else {
              resultEl.innerHTML += `
                <div class="result-box fail">
                    ğŸ˜¢ Kamu hanya menjawab ${score} dari ${quizData.length} dengan benar.<br>
                    <p>Pelajari kembali materinya sebelum mencoba lagi.</p>
                    <a href="{{ url_for('materi') }}" class="materi-btn">ğŸ“– Lihat Materi</a>
                </div>`;
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Terjadi kesalahan saat menyimpan nilai.");
          });
      }

      function shuffleQuestions(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      function soal_lanjut() {
        document.querySelector(".container-cerita").style.display = "none";
        document.querySelector(".quiz-container").style.display = "block";
        startTime = new Date(); // Mulai hitung waktu tepat saat quiz muncul
      }

      // Inisialisasi awal
      shuffleQuestions(quizData);
      loadQuestion();
    </script>
  </body>
</html>
